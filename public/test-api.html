<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>API Test - MVGFC Support System</title>
  <style>
    body {
      font-family: monospace;
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      background: #1e1e1e;
      color: #d4d4d4;
    }
    h1 {
      color: #4ec9b0;
    }
    .section {
      background: #252526;
      border: 1px solid #3e3e42;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }
    button {
      background: #2D7A3E;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px;
    }
    button:hover {
      background: #246830;
    }
    input {
      padding: 8px;
      border: 1px solid #3e3e42;
      background: #1e1e1e;
      color: #d4d4d4;
      border-radius: 4px;
      width: 200px;
      margin: 5px;
    }
    pre {
      background: #1e1e1e;
      border: 1px solid #3e3e42;
      border-radius: 4px;
      padding: 15px;
      overflow-x: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .success { color: #4ec9b0; }
    .error { color: #f48771; }
    .warning { color: #dcdcaa; }
    .info { color: #9cdcfe; }
  </style>
</head>
<body>
  <h1>üîç MVGFC API Test Tool</h1>
  <p>Use this to test your API endpoints and see the exact data structure</p>

  <div class="section">
    <h2>Test 1: Get All Tickets</h2>
    <button onclick="testGetAllTickets()">Test GET /api/tickets</button>
    <pre id="result1">Click button to test...</pre>
  </div>

  <div class="section">
    <h2>Test 2: Get Specific Ticket</h2>
    <input type="text" id="ticketNumber" placeholder="Enter ticket number" value="96871">
    <button onclick="testGetTicket()">Test GET /api/tickets/:id</button>
    <pre id="result2">Click button to test...</pre>
  </div>

  <div class="section">
    <h2>Test 3: Message Structure Analysis</h2>
    <button onclick="analyzeMessageStructure()">Analyze Messages</button>
    <pre id="result3">Click button to analyze...</pre>
  </div>

  <script>
    const API_BASE = window.location.origin;

    async function testGetAllTickets() {
      const result = document.getElementById('result1');
      result.textContent = 'Loading...';
      
      try {
        const response = await fetch(`${API_BASE}/api/tickets`);
        const data = await response.json();
        
        if (data.success) {
          result.innerHTML = `<span class="success">‚úÖ SUCCESS</span>

Total tickets: ${data.tickets.length}

Sample ticket structure:
${JSON.stringify(data.tickets[0], null, 2)}

<span class="info">Check if tickets have:</span>
- ticketNumber: ${data.tickets[0]?.ticketNumber ? '‚úÖ' : '‚ùå'}
- messages array: ${Array.isArray(data.tickets[0]?.messages) ? '‚úÖ' : '‚ùå'}
- messages[0].message: ${data.tickets[0]?.messages?.[0]?.message ? '‚úÖ' : '‚ùå'}
- messages[0].createdAt: ${data.tickets[0]?.messages?.[0]?.createdAt ? '‚úÖ' : '‚ùå'}`;
        } else {
          result.innerHTML = `<span class="error">‚ùå API returned success: false</span>

${JSON.stringify(data, null, 2)}`;
        }
      } catch (error) {
        result.innerHTML = `<span class="error">‚ùå ERROR</span>

${error.message}

<span class="warning">Make sure your server is running!</span>`;
      }
    }

    async function testGetTicket() {
      const ticketNumber = document.getElementById('ticketNumber').value;
      const result = document.getElementById('result2');
      result.textContent = 'Loading...';
      
      try {
        const response = await fetch(`${API_BASE}/api/tickets/${ticketNumber}`);
        const data = await response.json();
        
        if (data.success) {
          const ticket = data.ticket;
          result.innerHTML = `<span class="success">‚úÖ SUCCESS - Ticket #${ticket.ticketNumber}</span>

<span class="info">TICKET DATA:</span>
${JSON.stringify(ticket, null, 2)}

<span class="info">MESSAGES CHECK:</span>
- Has messages array: ${Array.isArray(ticket.messages) ? '‚úÖ' : '‚ùå'}
- Number of messages: ${ticket.messages?.length || 0}
- First message exists: ${ticket.messages?.[0] ? '‚úÖ' : '‚ùå'}

<span class="info">FIRST MESSAGE STRUCTURE:</span>
${ticket.messages?.[0] ? JSON.stringify(ticket.messages[0], null, 2) : 'No messages'}

<span class="info">FIELD CHECKS:</span>
- sender field: ${ticket.messages?.[0]?.sender || '‚ùå MISSING'}
- message field: ${ticket.messages?.[0]?.message || '‚ùå MISSING'}
- createdAt field: ${ticket.messages?.[0]?.createdAt || '‚ùå MISSING'}
- isInternal field: ${ticket.messages?.[0]?.isInternal !== undefined ? ticket.messages[0].isInternal : '‚ùå MISSING'}`;
        } else {
          result.innerHTML = `<span class="error">‚ùå NOT FOUND</span>

${JSON.stringify(data, null, 2)}`;
        }
      } catch (error) {
        result.innerHTML = `<span class="error">‚ùå ERROR</span>

${error.message}`;
      }
    }

    async function analyzeMessageStructure() {
      const result = document.getElementById('result3');
      result.textContent = 'Analyzing...';
      
      try {
        const response = await fetch(`${API_BASE}/api/tickets`);
        const data = await response.json();
        
        if (!data.success || !data.tickets.length) {
          result.textContent = 'No tickets found';
          return;
        }

        // Find first ticket with messages
        const ticketWithMessages = data.tickets.find(t => t.messages && t.messages.length > 0);
        
        if (!ticketWithMessages) {
          result.innerHTML = `<span class="warning">‚ö†Ô∏è NO MESSAGES FOUND</span>

All tickets have empty messages arrays.
Create a test ticket first!`;
          return;
        }

        const firstMsg = ticketWithMessages.messages[0];
        
        result.innerHTML = `<span class="success">‚úÖ FOUND MESSAGES</span>

<span class="info">Ticket: #${ticketWithMessages.ticketNumber}</span>
Total messages: ${ticketWithMessages.messages.length}

<span class="info">MESSAGE STRUCTURE:</span>
${JSON.stringify(firstMsg, null, 2)}

<span class="info">FIELD ANALYSIS:</span>
${Object.keys(firstMsg).map(key => {
  const value = firstMsg[key];
  const type = typeof value;
  return `- ${key}: <span class="info">${type}</span> = ${JSON.stringify(value)}`;
}).join('\n')}

<span class="info">ADMIN.JS EXPECTS:</span>
- msg.sender (string) - ${firstMsg.sender ? '‚úÖ Found' : '‚ùå Missing'}
- msg.message (string) - ${firstMsg.message ? '‚úÖ Found' : '‚ùå Missing'}
- msg.createdAt (date) - ${firstMsg.createdAt ? '‚úÖ Found' : '‚ùå Missing'}
- msg.isInternal (boolean) - ${firstMsg.isInternal !== undefined ? '‚úÖ Found' : '‚ùå Missing'}

<span class="${firstMsg.message && firstMsg.createdAt ? 'success' : 'error'}">
${firstMsg.message && firstMsg.createdAt ? 
  '‚úÖ Structure matches! Messages should display.' : 
  '‚ùå Structure mismatch! This is why messages don\'t show.'}
</span>

${!firstMsg.message ? '\n<span class="error">‚ö†Ô∏è PROBLEM: No "message" field!</span>\nBackend might be using "content", "text", or different field name.' : ''}
${!firstMsg.createdAt ? '\n<span class="error">‚ö†Ô∏è PROBLEM: No "createdAt" field!</span>\nBackend might be using "timestamp", "created_at", or different field name.' : ''}`;
      } catch (error) {
        result.innerHTML = `<span class="error">‚ùå ERROR</span>

${error.message}`;
      }
    }
  </script>
</body>
</html>